<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <title>Gate Collection Records</title>
Â  <link rel="stylesheet" href="style.css">
Â  <style>
Â  Â  .btn-delete {
Â  Â  Â  background-color: #e74c3c;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 5px 10px;
Â  Â  Â  margin-left: 5px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .btn-delete:hover {
Â  Â  Â  background-color: #c0392b;
Â  Â  }

Â  Â  .action-cell {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 5px;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="logo-container">
Â  Â  <img src="logo.jpg" class="logo" alt="Kakumiro Junior FC">
Â  Â  <h2>Kakumiro Junior FC</h2>
Â  </div>

Â  <h3>Gate Collection Records</h3>

Â  <input type="text" id="searchInput" placeholder="Search by name, date, event..." onkeyup="filterRecords()">

Â  <table id="gateTable">
Â  Â  <thead>
Â  Â  Â  <tr>
Â  Â  Â  Â  <th>Receipt No</th>
Â  Â  Â  Â  <th>Name</th>
Â  Â  Â  Â  <th>Phone</th>
Â  Â  Â  Â  <th>Event</th>
Â  Â  Â  Â  <th>Amount</th>
Â  Â  Â  Â  <th>Method</th>
Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  <th>Served By</th>
Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  </tr>
Â  Â  </thead>
Â  Â  <tbody></tbody>
Â  </table>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCOtWnclREDvlceNlpUFdUsjEy--zCCWww",
Â  Â  Â  authDomain: "gate-fee-system.firebaseapp.com",
Â  Â  Â  databaseURL: "https://gate-fee-system-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "gate-fee-system",
Â  Â  Â  storageBucket: "gate-fee-system.appspot.com",
Â  Â  Â  messagingSenderId: "35497617973",
Â  Â  Â  appId: "1:35497617973:web:ffb46ac4d5ea50206fdf7c"
Â  Â  };

Â  Â  const app = firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database(app);

Â  Â  // Start with local data as a fallback cache
Â  Â  let gateData = JSON.parse(localStorage.getItem('gateFeeData')) || [];
Â  Â  const currentUser = localStorage.getItem('currentUser') || '';
Â  Â  const tbody = document.querySelector("#gateTable tbody");

Â  Â  // Function to fetch data from Firebase
Â  Â  function fetchGateRecords() {
Â  Â  Â  // Request data once from the 'gateFees' node
Â  Â  Â  db.ref("gateFees").once("value", (snapshot) => {
Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  const recordsObject = snapshot.val();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Convert the Firebase object of objects into a renderable array
Â  Â  Â  Â  Â  gateData = Object.keys(recordsObject).map(key => recordsObject[key]).reverse();

Â  Â  Â  Â  Â  // Update localStorage for caching
Â  Â  Â  Â  Â  localStorage.setItem('gateFeeData', JSON.stringify(gateData));
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  console.log("Successfully loaded records from Firebase.");
Â  Â  Â  Â  Â  // Render the table with the new data
Â  Â  Â  Â  Â  renderTable(gateData);

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.log("No gate collection records found in Firebase. Checking local cache.");
Â  Â  Â  Â  Â  // If Firebase is empty, fall back to local data (which may also be empty)
Â  Â  Â  Â  Â  renderTable(gateData);
Â  Â  Â  Â  }
Â  Â  Â  }).catch(error => {
Â  Â  Â  Â  // If connection or permission fails, log error and use local cache
Â  Â  Â  Â  console.error("Firebase fetch failed (Check permissions!):", error.message);
Â  Â  Â  Â  renderTable(gateData); 
Â  Â  Â  });
Â  Â  }

Â  Â  function renderTable(data) {
Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  data.forEach((record, index) => {
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${record.receiptNo || ""}</td>
Â  Â  Â  Â  Â  <td>${record.name || ""}</td>
Â  Â  Â  Â  Â  <td>${record.contact || record.phone || ""}</td>
Â  Â  Â  Â  Â  <td>${record.event || ""}</td>
Â  Â  Â  Â  Â  <td>UGX ${record.amount || 0}</td>
Â  Â  Â  Â  Â  <td>${record.paymentMethod || record.method || ""}</td>
Â  Â  Â  Â  Â  <td>${record.date || ""}</td>
Â  Â  Â  Â  Â  <td>${record.servedBy || ""}</td>
Â  Â  Â  Â  Â  <td class="action-cell">
Â  Â  Â  Â  Â  Â  ${currentUser === "admin" ? `<button class="btn-delete" onclick="deleteRecord('${record.receiptNo}', ${index})">Delete</button>` : ""}
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  Â  function deleteRecord(receiptNo, index) {
Â  Â  Â  if (confirm("Are you sure you want to delete this record?")) {
Â  Â  Â  Â  // Remove from localStorage
Â  Â  Â  Â  gateData.splice(index, 1);
Â  Â  Â  Â  localStorage.setItem("gateFeeData", JSON.stringify(gateData));

Â  Â  Â  Â  // Remove from Firebase (assumes 'receiptNo' is a property you can search for)
Â  Â  Â  Â  db.ref("gateFees").orderByChild("receiptNo").equalTo(receiptNo).once("value", snapshot => {
Â  Â  Â  Â  Â  snapshot.forEach(child => {
Â  Â  Â  Â  Â  Â  // Delete the record using its unique key
Â  Â  Â  Â  Â  Â  db.ref("gateFees").child(child.key).remove();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // After successful deletion in Firebase, re-render the locally updated table
Â  Â  Â  Â  Â  renderTable(gateData);
Â  Â  Â  Â  Â  alert("Record deleted successfully.");
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  function filterRecords() {
Â  Â  Â  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
Â  Â  Â  const filtered = gateData.filter(r =>
Â  Â  Â  Â  Object.values(r).some(v => String(v).toLowerCase().includes(searchTerm))
Â  Â  Â  );
Â  Â  Â  renderTable(filtered);
Â  Â  }

Â  Â  // ðŸ”‘ Replace the old window.onload with the Firebase fetching function
Â  Â  window.onload = () => {
Â  Â  Â  fetchGateRecords();
Â  Â  };
Â  </script>

Â  <p style="text-align:center; margin-top: 40px; font-weight: bold;">One Team, One Dream</p>
</body>
</html>
