<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Records - Kakumiro Junior FC</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="back-arrow" onclick="window.history.back()">‚Üê Back</div>
  <img src="logo.jpg" alt="Kakumiro Junior FC" class="logo-center" />

  <h2>View Records</h2>
  <div class="tabs">
    <button onclick="switchTab('gate')">Gate Fee Records</button>
    <button onclick="switchTab('supporter')">Supporter Records</button>
  </div>

  <input type="text" id="searchInput" placeholder="Search..." oninput="filterTable()" />
  <button onclick="exportCSV()">Export CSV</button>

  <table id="recordTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <p class="motto">One Team, One Dream</p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCOtWnclREDvlceNlpUFdUsjEy--zCCWww",
      authDomain: "gate-fee-system.firebaseapp.com",
      databaseURL: "https://gate-fee-system-default-rtdb.firebaseio.com",
      projectId: "gate-fee-system",
      storageBucket: "gate-fee-system.appspot.com",
      messagingSenderId: "35497617973",
      appId: "1:35497617973:web:ffb46ac4d5ea50206fdf7c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentTab = 'gate';
    let allGateData = JSON.parse(localStorage.getItem('gateFeeData') || '[]');
    let allSupporterData = JSON.parse(localStorage.getItem('supportersData') || '[]');
    let currentUser = localStorage.getItem('currentUser') || 'admin';

    function switchTab(tab) {
      currentTab = tab;
      loadTable();
    }

    function loadTable() {
      const table = document.getElementById("recordTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (currentTab === "gate") {
        thead.innerHTML = `<tr>
          <th>Receipt</th><th>Name</th><th>Phone</th><th>Event</th>
          <th>Amount</th><th>Method</th><th>Date</th><th>Served By</th>
          ${currentUser === "admin" ? "<th>Actions</th>" : ""}
        </tr>`;
        allGateData.forEach((rec, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${rec.receiptNo || ""}</td><td>${rec.name || ""}</td>
            <td>${rec.contact || rec.phone || ""}</td><td>${rec.event || ""}</td>
            <td>UGX ${rec.amount || 0}</td><td>${rec.paymentMethod || rec.method || ""}</td>
            <td>${rec.date || ""}</td><td>${rec.servedBy || ""}</td>
            ${
              currentUser === "admin"
                ? `<td>
                    <button onclick="deleteRecord(${index}, 'gate')">Delete</button>
                    <button onclick="printReceipt(${index})">Print</button>
                   </td>`
                : ""
            }
          `;
          tbody.appendChild(row);
        });
      } else {
        thead.innerHTML = `<tr>
          <th>ID</th><th>Name</th><th>Phone</th><th>Gender</th>
          <th>Age</th><th>Location</th><th>Membership</th><th>Created By</th>
          ${currentUser === "admin" ? "<th>Actions</th>" : ""}
        </tr>`;
        allSupporterData.forEach((rec, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${rec.id || ""}</td><td>${rec.name || ""}</td>
            <td>${rec.phone || ""}</td><td>${rec.gender || ""}</td>
            <td>${rec.age || ""}</td><td>${rec.location || ""}</td>
            <td>${rec.membership || ""}</td><td>${rec.createdBy || ""}</td>
            ${
              currentUser === "admin"
                ? `<td><button onclick="deleteRecord(${index}, 'supporter')">Delete</button></td>`
                : ""
            }
          `;
          tbody.appendChild(row);
        });
      }
    }

    function deleteRecord(index, type) {
      if (!confirm("Are you sure you want to delete this record?")) return;

      if (type === "gate") {
        const record = allGateData[index];
        allGateData.splice(index, 1);
        localStorage.setItem("gateFeeData", JSON.stringify(allGateData));
        if (record.receiptNo) {
          db.ref("gateFeeData/" + record.receiptNo).remove();
        }
      } else {
        const record = allSupporterData[index];
        allSupporterData.splice(index, 1);
        localStorage.setItem("supportersData", JSON.stringify(allSupporterData));
        if (record.id) {
          db.ref("supportersData/" + record.id).remove();
        }
      }
      loadTable();
    }

    function printReceipt(index) {
      const rec = allGateData[index];
      const win = window.open("", "", "width=400,height=600");
      win.document.write(`
        <html><head><title>Receipt</title></head><body style="text-align: center;">
        <h2>Kakumiro Junior FC</h2>
        <h3>Gate Fee Receipt</h3>
        <p><strong>Event:</strong> ${rec.event}</p>
        <p><strong>Name:</strong> ${rec.name}</p>
        <p><strong>Amount Paid:</strong> UGX ${rec.amount}</p>
        <p><strong>Method:</strong> ${rec.paymentMethod}</p>
        <p><strong>Date:</strong> ${rec.date}</p>
        <p><strong>Served By:</strong> ${rec.servedBy}</p>
        <h4>One Team, One Dream</h4>
        </body></html>
      `);
      win.document.close();
      win.print();
    }

    function filterTable() {
      const term = document.getElementById("searchInput").value.toLowerCase();
      const tbody = document.querySelector("#recordTable tbody");
      const data = currentTab === 'gate' ? allGateData : allSupporterData;
      tbody.innerHTML = "";
      const filtered = data.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(term)));
      filtered.forEach((rec, index) => {
        const row = document.createElement("tr");
        if (currentTab === 'gate') {
          row.innerHTML = `
            <td>${rec.receiptNo || ""}</td><td>${rec.name || ""}</td>
            <td>${rec.contact || rec.phone || ""}</td><td>${rec.event || ""}</td>
            <td>UGX ${rec.amount || 0}</td><td>${rec.paymentMethod || rec.method || ""}</td>
            <td>${rec.date || ""}</td><td>${rec.servedBy || ""}</td>
            ${
              currentUser === "admin"
                ? `<td>
                    <button onclick="deleteRecord(${index}, 'gate')">Delete</button>
                    <button onclick="printReceipt(${index})">Print</button>
                  </td>`
                : ""
            }
          `;
        } else {
          row.innerHTML = `
            <td>${rec.id || ""}</td><td>${rec.name || ""}</td>
            <td>${rec.phone || ""}</td><td>${rec.gender || ""}</td>
            <td>${rec.age || ""}</td><td>${rec.location || ""}</td>
            <td>${rec.membership || ""}</td><td>${rec.createdBy || ""}</td>
            ${
              currentUser === "admin"
                ? `<td><button onclick="deleteRecord(${index}, 'supporter')">Delete</button></td>`
                : ""
            }
          `;
        }
        tbody.appendChild(row);
      });
    }

    function exportCSV() {
      const data = currentTab === 'gate' ? allGateData : allSupporterData;
      let csv = currentTab === 'gate'
        ? "Receipt No,Name,Phone,Event,Amount,Method,Date,Served By\n"
        : "ID,Name,Phone,Gender,Age,Location,Membership,Created By\n";
      data.forEach(d => {
        csv += currentTab === 'gate'
          ? `${d.receiptNo || ""},${d.name || ""},${d.contact || d.phone || ""},${d.event || ""},${d.amount || 0},${d.paymentMethod || d.method || ""},${d.date || ""},${d.servedBy || ""}\n`
          : `${d.id || ""},${d.name || ""},${d.phone || ""},${d.gender || ""},${d.age || ""},${d.location || ""},${d.membership || ""},${d.createdBy || ""}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = currentTab === 'gate' ? "gate_fee_records.csv" : "supporter_records.csv";
      link.click();
    }

    window.onload = loadTable;
  </script>
</body>
</html>
